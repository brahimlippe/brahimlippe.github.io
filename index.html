<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <title>تمرين تتبع الطبقة الصوتية</title>
    <style>
      #fine-detune-slider-handle {
	  width: 3em;
	  height: 1.6em;
	  top: 50%;
	  margin-top: -.8em;
	  text-align: center;
	  line-height: 1.6em;
      }
      #detune-slider-handle {
	  width: 3em;
	  height: 1.6em;
	  top: 50%;
	  margin-top: -.8em;
	  text-align: center;
	  line-height: 1.6em;
      }
      #volume-slider-handle {
	  width: 3em;
	  height: 1.6em;
	  top: 50%;
	  margin-top: -.8em;
	  text-align: center;
	  line-height: 1.6em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <form class="my-3">
	<div class="form-group">
	  <label for="file_input">أدخل الملف الصوتي</label>
	  <input class="form-control" type="file" name="الصوت" id="file_input">
	</div>
      </form>
      <audio id="audio" controls class="mx-auto d-block w-75">
	<source src="" id="src"/>
      </audio>
      <canvas class="m-2" id="visualizer" width="640" height="100"></canvas> 
      <p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px;">
	<span class="ui-icon ui-icon-signal" style="float:left; margin:-2px 5px 0 0;"></span>
	محرك الطبقة الصوتية
      </p>
      <div id="detune-slider" class="my-3">
	  <div id="detune-slider-handle" class="ui-slider-handle"></div>
      </div>
      <p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px;">
	<span class="ui-icon ui-icon-signal" style="float:left; margin:-2px 5px 0 0;"></span>
	محرك الطبقة الصوتية الدقيق
      </p>
      <div id="fine-detune-slider" class="my-3">
	  <div id="fine-detune-slider-handle" class="ui-slider-handle"></div>
      </div>
      <p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px;">
	<span class="ui-icon ui-icon-volume-on" style="float:left; margin:-2px 5px 0 0;"></span>
	شدة الصوت
      </p>
      <div id="volume-slider" class="my-3">
	  <div id="volume-slider-handle" class="ui-slider-handle"></div>
      </div>
      <div class="row">
	<div class="col border border-dark keyboard-btn mx-1" style="height:100px;" id="note0">
	  <p class="text-center" style="position:relative;top:30%;">1</p>
	</div>
	<div class="col border border-dark keyboard-btn mx-1" style="height:100px;" id="note1">
	  <p class="text-center" style="position:relative;top:30%;">2</p>
	</div>
	<div class="col border border-dark keyboard-btn mx-1" style="height:100px;" id="note2">
	  <p class="text-center" style="position:relative;top:30%;">3</p>
	</div>
	<div class="col border border-dark keyboard-btn mx-1" style="height:100px;" id="note3">
	  <p class="text-center" style="position:relative;top:30%;">4</p>
	</div>
	<div class="col border border-dark keyboard-btn mx-1" style="height:100px;" id="note4">
	  <p class="text-center" style="position:relative;top:30%;">5</p>
	</div>
	<div class="col border border-dark keyboard-btn mx-1" style="height:100px;" id="note5">
	  <p class="text-center" style="position:relative;top:30%;">6</p>
	</div>
	<div class="col border border-dark keyboard-btn mx-1" style="height:100px;" id="note6">
	  <p class="text-center" style="position:relative;top:30%;">7</p>
	</div>
      </div>
    </div>
    <script>
      const audioElement = document.querySelector('#audio');
      function onNoteClick() {
	  source.detune.value = makam[parseInt(this.id[4])];
	  audio.play();
      }
      document.querySelector("#file_input").addEventListener("change", readFile, false);
      var i;
      var makam = [0, 111.73, 315.64, 498.04, 701.95, 813.68, 1017.59, 1200];
      for (i = 0; i < 7; i++) {
	  document.querySelector("#note" + i).addEventListener("click", onNoteClick, false);
      }
      var canvas = document.querySelector('#visualizer');
      var canvasCtx = canvas.getContext("2d");
      var intendedWidth = document.querySelector('.container').clientWidth;
      canvas.setAttribute('width',intendedWidth);
      const audioContext = new AudioContext();
      const track = audioContext.createMediaElementSource(audioElement);
      const gainNode = audioContext.createGain();
      const source = audioContext.createBufferSource();
      const sourceAnalyser = audioContext.createBufferSource();
      const analyser = audioContext.createAnalyser();
      source.playbackRate.value = 1.0;
      source.loop = true;
      analyser.minDecibels = -90;
      analyser.maxDecibels = -10;
      analyser.smoothingTimeConstant = 0.2;
      analyser.fftSize = 8192;
      const streamNode = audioContext.createMediaStreamDestination();
      sourceAnalyser.connect(analyser);
      sourceAnalyser.onended = function(event) {
	  WIDTH = canvas.width;
	  HEIGHT = canvas.height;
	  var canvasStyle = "bars";
	  if(canvasStyle === "sine") {
	      var bufferLength = analyser.fftSize;
	      console.log(bufferLength);
	      var dataArray = new Uint8Array(bufferLength);
	      canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
	      analyser.getByteTimeDomainData(dataArray);
	      canvasCtx.fillStyle = 'rgb(200, 200, 200)';
	      canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
	      canvasCtx.lineWidth = 2;
	      canvasCtx.strokeStyle = 'rgb(0, 0, 0)';
	      canvasCtx.beginPath();

	      var sliceWidth = WIDTH * 1.0 / bufferLength;
	      var x = 0;
	      for(var i = 0; i < bufferLength; i++) {
		  var v = dataArray[i] / 128.0;
		  var y = v * HEIGHT/2;
		  if(i === 0) {
		      canvasCtx.moveTo(x, y);
		  } else {
		      canvasCtx.lineTo(x, y);
		  }
		  x += sliceWidth;
	      }
	      canvasCtx.lineTo(canvas.width, canvas.height/2);
	      canvasCtx.stroke();
	  } else if(canvasStyle === "bars") {
	      var bufferLengthAlt = analyser.frequencyBinCount;
	      console.log(bufferLengthAlt);
	      var dataArrayAlt = new Uint8Array(bufferLengthAlt);

	      canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

	      analyser.getByteFrequencyData(dataArrayAlt);

	      canvasCtx.fillStyle = 'rgb(0, 0, 0)';
	      canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

	      const barWidth = (WIDTH / bufferLengthAlt) * 2.5;
	      var x = 0;

	      for(var i = 0; i < bufferLengthAlt; i++) {
		  var barHeight = dataArrayAlt[i];

		  canvasCtx.fillStyle = 'rgb(' + (barHeight+100) + ',50,50)';
		  canvasCtx.fillRect(x,HEIGHT-barHeight/2,barWidth,barHeight/2);

		  x += barWidth + 1;
	      }
	  } else {
	      canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
	      canvasCtx.fillStyle = "red";
	      canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
	  }
      }
      source.connect(gainNode).connect(streamNode);
      document.getElementById("audio").srcObject = streamNode.stream;
      function readFile() {
	  reader = new FileReader();
	  reader.onload = (e) => {
	      const audioBuffer = audioContext.decodeAudioData(e.target.result,
							       (buf) => {
								   source.buffer = buf
								   sourceAnalyser.buffer = buf
								   source.start(0);
								   sourceAnalyser.start(0);
							       },
							       () => { console.log("Decoding audio buffer failed"); });
	  };
	  reader.readAsArrayBuffer(this.files[0]);
      };
      $(function() {
	  var detune_handle = $( "#detune-slider-handle" );
	  var fine_detune_handle = $( "#fine-detune-slider-handle" );
	  var volume_handle = $( "#volume-slider-handle" );
	  $("#detune-slider").slider({
	      min: -1200,
	      max: 1200,
	      value: 0,
	      create: function() {
		  detune_handle.text($(this).slider("value"));
	      },
	      slide: function(event, ui) {
		  detune_handle.text(ui.value);
		  source.detune.value = ui.value + $("#fine-detune-slider").slider("option", "value");
	      }
	  });
	  $("#fine-detune-slider").slider({
	      min: -200,
	      max: 200,
	      value: 0,
	      create: function() {
		  fine_detune_handle.text($(this).slider("value"));
	      },
	      slide: function(event, ui) {
		  fine_detune_handle.text(ui.value);
		  source.detune.value = ui.value + $("#detune-slider").slider("option", "value");
	      }
	  });
	  $("#volume-slider").slider({
	      min: 0,
	      max: 2,
	      value: 1,
	      step: 0.1,
	      create: function() {
		  volume_handle.text($(this).slider("value"));
	      },
	      slide: function(event, ui) {
		  gainNode.gain.value = ui.value;
		  volume_handle.text($(this).slider("value"));
	      }
	  });
      });
    </script>
  </body>
</html>
