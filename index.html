<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <title>تمرين تتبع الطبقة الصوتية</title>
    <style>
      #fine-detune-slider-handle {
	  width: 3em;
	  height: 1.6em;
	  top: 50%;
	  margin-top: -.8em;
	  text-align: center;
	  line-height: 1.6em;
      }
      #detune-slider-handle {
	  width: 3em;
	  height: 1.6em;
	  top: 50%;
	  margin-top: -.8em;
	  text-align: center;
	  line-height: 1.6em;
      }
      #volume-slider-handle {
	  width: 3em;
	  height: 1.6em;
	  top: 50%;
	  margin-top: -.8em;
	  text-align: center;
	  line-height: 1.6em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <form class="my-3">
	<div class="form-group">
	  <label for="file_input">أدخل الملف الصوتي</label>
	  <input class="form-control" type="file" name="الصوت" id="file_input">
	</div>
      </form>
      <p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px;">
	<span class="ui-icon ui-icon-signal" style="float:left; margin:-2px 5px 0 0;"></span>
	محرك الطبقة الصوتية
      </p>
      <div id="detune-slider" class="my-3">
	  <div id="detune-slider-handle" class="ui-slider-handle"></div>
      </div>
      <p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px;">
	<span class="ui-icon ui-icon-signal" style="float:left; margin:-2px 5px 0 0;"></span>
	محرك الطبقة الصوتية الدقيق
      </p>
      <div id="fine-detune-slider" class="my-3">
	  <div id="fine-detune-slider-handle" class="ui-slider-handle"></div>
      </div>
      <p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px;">
	<span class="ui-icon ui-icon-volume-on" style="float:left; margin:-2px 5px 0 0;"></span>
	شدة الصوت
      </p>
      <div id="volume-slider" class="my-3">
	  <div id="volume-slider-handle" class="ui-slider-handle"></div>
      </div>
      <audio id="audio" controls class="mx-auto d-block w-75">
	<source src="" id="src"/>
      </audio>
    </div>
    <script>
      document.querySelector("#file_input").addEventListener("change", readFile, false);
      const audioContext = new AudioContext();
      const audioElement = document.querySelector('#audio');
      const track = audioContext.createMediaElementSource(audioElement);
      const gainNode = audioContext.createGain();
      const source = audioContext.createBufferSource();
      source.playbackRate.value = 1.0;
      source.loop = true;
      const streamNode = audioContext.createMediaStreamDestination();
      source.connect(gainNode).connect(streamNode);
      document.getElementById("audio").srcObject = streamNode.stream;
      function readFile() {
	  reader = new FileReader();
	  reader.onload = (e) => {
	      const audioBuffer = audioContext.decodeAudioData(e.target.result,
							       (buf) => {
								   source.buffer = buf
								   source.start(0);
								   console.log("Decoding audio buffer successful");
								   console.log(buf)
							       },
							       () => { console.log("Decoding audio buffer failed"); });
	  };
	  reader.readAsArrayBuffer(this.files[0]);
      };
      $(function() {
	  var detune_handle = $( "#detune-slider-handle" );
	  var fine_detune_handle = $( "#fine-detune-slider-handle" );
	  var volume_handle = $( "#volume-slider-handle" );
	  $("#detune-slider").slider({
	      min: -1200,
	      max: 1200,
	      value: 0,
	      create: function() {
		  detune_handle.text($(this).slider("value"));
	      },
	      slide: function(event, ui) {
		  detune_handle.text(ui.value);
		  source.detune.value = ui.value + $("#fine-detune-slider").slider("option", "value");
	      }
	  });
	  $("#fine-detune-slider").slider({
	      min: -200,
	      max: 200,
	      value: 0,
	      create: function() {
		  fine_detune_handle.text($(this).slider("value"));
	      },
	      slide: function(event, ui) {
		  fine_detune_handle.text(ui.value);
		  source.detune.value = ui.value + $("#detune-slider").slider("option", "value");
	      }
	  });
	  $("#volume-slider").slider({
	      min: 0,
	      max: 2,
	      value: 1,
	      step: 0.1,
	      create: function() {
		  volume_handle.text($(this).slider("value"));
	      },
	      slide: function(event, ui) {
		  gainNode.gain.value = ui.value;
		  volume_handle.text($(this).slider("value"));
	      }
	  });
      });
    </script>
  </body>
</html>
